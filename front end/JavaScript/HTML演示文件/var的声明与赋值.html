<!DOCTYPE html>
<link rel="stylesheet" href="css/base.css">

<div class="main">
  <button onclick="withIIFE()">with中var的赋值</button>
</div>

<script>
  /*
   * 在只有 var，没有 let 的旧 JavaScript 时代，诞生了一个技巧，叫做：立即执行的函数表达式（IIFE），通过创建一个函数并立即执行，来构造一个新的域，从而控制var的范围
   */

  // 由于语法规定了function关键字开头是函数声明，所以要想让函数变为函数表达式，必须加点东西，最常见的做法是加括号
  ;(function(){
    var a;
    // code
  }())
  // 括号有个缺点，如果上一行代码不写分号，括号会被解释为上一行代码最末的函数调用，产生完全不符合预期，并且难以调试的行为。
  ;(function(){
    var a;
    // code
  })()

  // void 关键字，有效避免了语法问题，同时，语义上 void 运算表示忽略表达式后面的值，变成undefined，IIFE的返回值确实不需要，所以语义也更加合理。
  void function()
  {
    var a;
    //code
  }();

  // 值得特别注意的是，有时候 var 的特性会导致声明的变量和被赋值的变量是两个b，JS 中有特例，那就是使用 with 的时候
  function withIIFE()
  {
    var b;
    void function()
    {
      var env = { b : 1};
      b = 2;
      // with 内的 var b;作用到了function内
      console.log("In function b: " + b); // 2
      with(env)
      {
        var b = 3;
        console.log("In with b: " + b); // 3
      }
    }();
    console.log("Global b: " + b); // undefined
  }
</script>