---
title : 微信小程序
author: dsy
---

<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

- [微信小程序](#微信小程序)
  - [一. 基础](#一-基础)
    - [1.1 开始](#11-开始)
      - [1.1.1 申请账号并预览小程序](#111-申请账号并预览小程序)
      - [1.1.2 小程序代码构成](#112-小程序代码构成)
        - [1.1.2.1 JSON 配置](#1121-json-配置)
        - [1.1.2.2 WXML 模板](#1122-wxml-模板)
        - [1.1.2.3 WXSS 样式](#1123-wxss-样式)
        - [1.1.2.4 JS 逻辑交互](#1124-js-逻辑交互)
      - [1.1.3 小程序宿主环境](#113-小程序宿主环境)
        - [1.1.3.1 渲染层和逻辑层](#1131-渲染层和逻辑层)
        - [1.1.3.2 程序与页面](#1132-程序与页面)
        - [1.1.3.3 组件](#1133-组件)
        - [1.1.3.4 API](#1134-api)
      - [1.1.4 小程序协同工作与发布](#114-小程序协同工作与发布)
      - [1.1.5 目录结构](#115-目录结构)
    - [1.2 配置小程序](#12-配置小程序)
      - [1.2.1 全局配置](#121-全局配置)

<!-- /code_chunk_output -->

# 微信小程序

## 一. 基础

小程序与普通网页开发的区别

1. ​网页开发渲染线程和脚本线程是互斥的，这也是为什么长时间的脚本运行可能会导致页面失去响应，而在小程序中，二者是分开的，分别运行在不同的线程中。
2. 网页开发可以使用到各种浏览器暴露出来的 DOM API，进行 DOM 选中和操作。而小程序的逻辑层和渲染层是分开的，逻辑层运行在 JSCore 中，并没有一个完整浏览器对象，因而缺少相关的DOM API和BOM API。这一区别导致了前端开发非常熟悉的一些库，例如 jQuery、 Zepto 等，在小程序中是无法运行的。
3. JSCore 的环境同 NodeJS 环境也是不尽相同，所以一些 NPM 的包在小程序中也是无法运行的。

小程序开发过程中需要面对的是两大操作系统 **iOS** 和 **Android** 的微信客户端，以及用于辅助开发的小程序开发者工具，小程序中三大运行环境也是有所区别的

运行环境 | 逻辑层 | 渲染层
--------|-------|-------
iOS  | JavaScriptCore | WKWebView
安卓 | V8 | 定制内核
小程序开发工具 | NWJS | Chrome WebView

### 1.1 开始

#### 1.1.1 申请账号并预览小程序

进入 [小程序注册页](https://mp.weixin.qq.com/wxopen/waregister?action=step1) 根据指引填写信息和提交相应的资料，申请账号

在小程序管理平台，可以管理小程序的权限，查看数据报表，发布小程序等操作。

登录 [微信公众平台](https://mp.weixin.qq.com/) ，可以在菜单 “开发”-"开发设置"-“开发设置” 中看到小程序的 **AppID** 。

小程序的 AppID 相当于小程序平台的一个身份证，后续会在很多地方要用到 AppID （注意这里要区别于服务号或订阅号的 AppID）。

新建项目选择小程序项目，选择代码存放的硬盘路径，填入小程序的 AppID，给项目起名字，勾选 "不使用云服务" （注意: 要选择一个空的目录才可以创建项目），点击新建，点击顶部菜单编译就可以在微信开发者工具中预览小程序。

#### 1.1.2 小程序代码构成

##### 1.1.2.1 JSON 配置

JSON 是一种数据格式，并不是编程语言，在小程序中，JSON扮演的是静态配置的角色。
在项目的根目录有一个 *app.json* 和 *project.config.json*，此外在 *pages/logs* 目录下还有一个 *logs.json*

- 小程序配置 app.js
  app.json 是当前小程序的全局配置，包括了小程序的所有页面路径、界面表现、网络超时时间、底部 tab 等。完整配置项说明请参考 [小程序全局配置](https://developers.weixin.qq.com/miniprogram/dev/reference/configuration/app.html)

- 工具配置 project.config.json
  在工具上做的任何配置都会写入到 project.config.json，当重新安装工具或者换电脑工作时，只要载入同一个项目的代码包，开发者工具就自动会恢复到开发项目时的个性化配置。其他配置项细节可以参考文档 [开发者工具配置](https://developers.weixin.qq.com/miniprogram/dev/devtools/projectconfig.html)

- 页面配置 page.json
  这里的 page.json 是用来表示 pages/logs 目录下的 logs.json 这类和小程序页面相关的配置。让开发者可以独立定义每个页面的一些属性，例如: 顶部颜色、是否允许下拉刷新等等。其他配置项细节可以参考文档 [页面配置](https://developers.weixin.qq.com/miniprogram/dev/reference/configuration/page.html)

- JSON 语法注意事项
  1. JSON文件都是被包裹在一个大括号中 {}，通过key-value的方式来表达数据。
  2. JSON的Key必须包裹在一个双引号中
  3. JSON的值只能是以下几种数据格式，其他任何格式都会触发报错
      - 数字，包含浮点数和整数
      - 字符串，需要包裹在双引号中
      - boolean值，true 或者 false
      - 数组，需要包裹在方括号中 []
      - 对象，需要包裹在大括号中 {}
      - Null
  4. JSON 文件中无法使用注释，试图添加注释将会引发报错。

##### 1.1.2.2 WXML 模板

在小程序中 WXML 充当的是类似 HTML 的角色。和 HTML 非常相似，WXML 由标签、属性等等构成。但是也有很多不一样的地方:

1. 小程序的 WXML 用的标签是 view, button, text 等等，这些标签是小程序给开发者包装好的基本能力，还提供了地图、视频、音频等等组件能力。
2. 多了一些 **wx:if** 这样的属性以及 **{{ }}** 这样的表达式
  现在提倡把渲染和逻辑分离。简单来说就是不要再让 JS 直接操控 DOM，JS 只需要管理**状态**，然后再通过一种模板语法来描述状态和界面结构的关系即可。小程序的框架也是用到了这个思路。

WXML这样写

```wxml
<text>{{msg}}</text>
```

JS只需要管理状态即可

```js
this.setData({
  msg : "This is a cat"
})
```

通过 {{ }} 的语法把一个变量绑定到界面上，称为数据绑定。仅仅通过数据绑定还不够完整的描述状态和界面的关系，还需要 if/else, for 等控制能力，在小程序里边，这些控制能力都用 `wx:` 开头的属性来表达。详细的文档可以参考 [WXML](https://developers.weixin.qq.com/miniprogram/dev/reference/wxml/)

##### 1.1.2.3 WXSS 样式

WXSS 具有 CSS 大部分的特性，小程序在 WXSS 也做了一些扩充和修改。更详细的文档可以参考 [WXSS](https://developers.weixin.qq.com/miniprogram/dev/framework/view/wxss.html)

1. WXSS 在底层支持新的尺寸单位 `rpx` ，开发者可以免去换算的烦恼，只要交给小程序底层来换算即可，由于换算采用的浮点数运算，所以运算结果会和预期结果有一点点偏差。
2. 提供了全局的样式和局部样式。和前边 app.json, page.json 的概念相同，可以写一个 **app.wxss** 作为全局样式，会作用于当前小程序的所有页面，局部页面样式 **page.wxss** 仅对当前页面生效。
3. WXSS 仅支持部分 CSS 选择器

##### 1.1.2.4 JS 逻辑交互

一个服务仅仅只有界面展示是不够的，还需要和用户做交互：响应用户的点击、获取用户的位置等等。在小程序里边，可以通过编写 **JS** 脚本文件来处理用户的操作。更详细的事件可以参考文档 [WXML事件](https://developers.weixin.qq.com/miniprogram/dev/framework/view/wxml/event.html)

```wxml
<view>{{msg}}</view>
<button onclick="clickMe">点击</button>
```

点击 button 按钮的时候，希望把界面上 msg 显示成 "this is a cat"，于是在 button 上声明一个属性: **bindtap** ，在 JS 文件里边声明了 **clickMe** 方法来响应这次点击操作

```js
page({
  clickMe : function () {
    this.setData({msg: "this is a cat"});
  }
})
```

此外还可以在 JS 中调用小程序提供的丰富的 API，利用这些 API 可以很方便的调起微信提供的能力，例如获取用户信息、本地存储、微信支付等。更多 API 可以参考文档 [小程序的API](https://developers.weixin.qq.com/miniprogram/dev/api/) 。

#### 1.1.3 小程序宿主环境

微信客户端给小程序所提供的环境叫宿主环境。小程序借助宿主环境提供的能力，可以完成许多普通网页无法完成的功能。

##### 1.1.3.1 渲染层和逻辑层

小程序的运行环境分成渲染层和逻辑层，其中 WXML 模板和 WXSS 样式工作在渲染层，JS 脚本工作在逻辑层。

小程序的渲染层和逻辑层分别由2个线程管理：渲染层的界面使用了 **WebView** 进行渲染；逻辑层采用 **JsCore** 线程运行JS脚本。一个小程序存在多个界面，所以渲染层存在多个WebView线程，这两个线程的通信会经由微信客户端做中转，逻辑层发送网络请求也经由微信客户端转发，小程序的通信模型如下图所示。

![微信小程序通信模型](./image/微信小程序通信模型.png)

有关渲染层和逻辑层的详细文档参考 [小程序框架](https://developers.weixin.qq.com/miniprogram/dev/framework/MINA.html)

##### 1.1.3.2 程序与页面

微信客户端在打开小程序之前，会把整个小程序的代码包下载到本地。紧接着通过 app.json 的 **pages** 字段就可以知道你当前小程序的所有页面路径。

如果没有定义 entryPagePath 属性，默认 pages 列表的第一项为小程序的默认启动路径（首页）。不支持带页面路径参数。

于是微信客户端就把首页的代码装载进来，通过小程序底层的一些机制，就可以渲染出首页。

小程序启动之后，在 app.js 定义的 App 实例的 onLaunch 回调会被执行。整个小程序只有一个 App 实例，是全部页面共享的，更多的事件回调参考文档 [注册程序 App](https://developers.weixin.qq.com/miniprogram/dev/reference/api/App.html) 。

pages/logs/logs 下包括了4种文件，微信客户端会先根据 logs.json 配置生成一个界面，顶部的颜色和文字你都可以在这个 json 文件里边定义好。紧接着客户端就会装载这个页面的 WXML 结构和 WXSS 样式。最后客户端会装载 logs.js，logs.js 的大体内容就是:

```js
Page({
  data: { // 参与页面渲染的数据
    logs: []
  },
  onLoad: function () {
    // 页面渲染后 执行
  }
})
```

Page 是一个页面构造器，这个构造器就生成了一个页面。在生成页面的时候，小程序框架会把 data 数据和 logs.wxml 一起渲染出最终的结构。在渲染完界面之后，页面实例就会收到一个 onLoad 的回调，可以在这个回调处理需要的逻辑。有关于 Page 构造器更多详细的文档参考 [注册页面 Page](https://developers.weixin.qq.com/miniprogram/dev/framework/app-service/page.html)

##### 1.1.3.3 组件

小程序提供了丰富的基础组件给开发者，开发者可以像搭积木一样，组合各种组件拼合成自己的小程序。

在小程序里边，只需要在 WXML 写上对应的组件标签名字就可以把该组件显示在界面上，例如，在界面显示地图：

> `<map></map>`

使用组件的时候，还可以通过属性传递值给组件，让组件可以以不同的状态去展现，例如，希望地图一开始的中心的经纬度是北京，那么需要声明地图的 longitude（中心经度） 和 latitude（中心纬度）两个属性:

> `<map longitude="116.397128" latitude="39.916527"></map>`

组件的内部行为也会通过事件的形式让开发者可以感知，例如用户点击了地图上的某个标记，可以在 js 编写 markertap 函数来处理：

> <map bindmarkertap="markertap" longitude="116.397128" latitude="39.916527"></map>

也可以通过 style 或者 class 来控制组件的外层样式，以便适应界面宽度高度等等。更多的组件可以参考 [小程序组件](https://developers.weixin.qq.com/miniprogram/dev/component/) 。

##### 1.1.3.4 API

为了让开发者可以很方便的调起微信提供的能力，例如获取用户信息、微信支付等等，小程序提供了很多 API 。更多的 API 可以参考文档 [小程序的API](https://developers.weixin.qq.com/miniprogram/dev/api/)。

要获取用户的地理位置时，只需要：

```js
wx.getLocation({
  type: 'wgs84',
  success: (res) => {
    var latitude = res.latitude // 纬度
    var longitude = res.longitude // 经度
  }
})
```

注意：多数 API 的回调都是异步，你需要处理好代码逻辑的异步问题。

#### 1.1.4 小程序协同工作与发布

#### 1.1.5 目录结构

小程序包含一个描述整体程序的 app 和多个描述各自页面的 page。

一个小程序主体部分由三个文件组成，必须放在项目的根目录，如下：

文件 | 必需 | 作用
-----|------|----
app.js | 是 | 小程序逻辑
app.json | 是 | 小程序公共配置
app.wxss | 否 | 小程序公共样式表

一个小程序页面由四个文件组成，分别是：

文件类型 | 必需 | 作用
-----|------|----
js | 是	| 页面逻辑
wxml | 是 | 页面结构
json | 否 | 页面配置
wxss | 否 | 页面样式表

> **注意**：为了方便开发者减少配置项，描述页面的四个文件必须具有相同的路径与文件名。

**允许上传的文件**
在项目目录中，以下文件会经过编译，因此上传之后无法直接访问到：.js、app.json、.wxml、*.wxss（其中 wxml 和 wxss 文件仅针对在 app.json 中配置了的页面）。除此之外，只有后缀名在白名单内的文件可以被上传，不在白名单列表内文件在开发工具能被访问到，但无法被上传。具体白名单列表如下：

1. wxs
2. png
3. jpg
4. jpeg
5. gif
6. svg
7. json
8. cer
9. mp3
10. aac
11. m4a
12. mp4
13. wav
14. ogg
15. silk

### 1.2 配置小程序

#### 1.2.1 全局配置
