---
title: 微信小程序全栈开发实战
---

<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

- [微信小程序全栈开发实战](#微信小程序全栈开发实战)
  - [一. 工具、原理及框架](#一-工具-原理及框架)
    - [1.1 icon 组件: 关于图标的 4 个方案](#11-icon组件-关于图标的4个方案)
  - [二. 基础](#二-基础)
  - [三. 实践](#三-实践)

<!-- /code_chunk_output -->

# 微信小程序全栈开发实战

## 一. 工具、原理及框架

### 1.1 icon 组件

```wxml
<icon type="success" size="30rpx" color="green">
// type类型范围 success, success_no_circle, info, warn, waiting, cancel, download, search, clear
```

> 改变颜色时，改变的是所有像素的颜色，因为本质上图标是一个像素的集合

**图标与文本可以放在同一段落中**。

#### 1.1.1 关于自定义图标的 5 个实现方案及具体原理是什么

1. 使用图片

   - 缺点:
     - 图标多，会有大量 HTTP 请求
     - 不方便修改颜色
     - 图标放大会变虚

2. 使用精灵图(连续图片集)
   精灵图是一组图片，以非重叠、最小化分布的方式排列成一张图片，在加载的时候只加载一次，减少了 HTTP 请求
   通过控制每次显示的纵横起点坐标及区域大小来显示

   ```wxss
   .sprite_icon {
     display: block;
     width: 80px;
     height: 80px;
     /* 此处在wxss中，可以使用网络图片，不能使用本地图片 */
     background: url("https://cdn.nlark.com/..1bd0.png") -180xp -310px;
   }
   ```

3. 使用 CSS 样式绘制

   - 缺点
     - 工作量大
     - 位置，大小，颜色不方便控制

4. 使用矢量字体
   当浏览器渲染字符时，首先看 font-family 样式，确定需要使用的字体名是哪一个，由字体名确定使用电脑里哪一个字体文件渲染。
   接着以字符的 unicode 在字体文件里查找对应的字符信息，每个 unicode 都在字体文件中有唯一对应的字符描述信息。字体类型有两类，点阵字体和矢量字体，现在使用最广泛的是矢量字体，矢量字体又分为三类：

   - Adobe 主导的 Type1，使用三次贝塞尔曲线来绘制字形
   - Apple 和 Microsoft 主导的 TrueType，使用二次贝塞尔曲线绘制字形
   - Adobe、Apple 和 Microsoft 共同主导的开源字体 OpenType
     在矢量字体文件里，每个 unicode 仅是编码的索引，每个字符描述信息是一个几何矢量绘图描述信息
     由于矢量字体是绘制出来的，所以它**可以实时填充任何颜色，可以无极缩放而没有锯齿**
     可以定义任何一个矢量图形与一个 unicode 对应，可以使用 [阿里巴巴矢量图标库](https://www.iconfont.cn/home/index?spm=a313x.7781069.1998910419.2) 来下载常用图标 和 自定义矢量图标字体
     **在小程序里建议使用 TTF 和 WOFF 格式。**

   ```wxss
   <!-- 兼容不同的浏览器环境，浏览器会从列表的第一个开始尝试加载，获得一个可用格式，就不会再尝试其他文件了 -->
   @font-face {
     font-family: 'iconfont';
     <!-- EOT 是微软IE浏览器专用的OpenType字体类型 -->
     src: url('//at.alicdn.com/t/font_1716930_3m30jvz589y.eot');
     src: url('//at.alicdn.com/t/font_1716930_3m30jvz589y.eot?#iefix') format('embedded-opentype'),
     <!-- woff2 和 woff 是移动开发专用的矢量格式字体，是对三种矢量字体格式的再封装 -->
     url('//at.alicdn.com/t/font_1716930_3m30jvz589y.woff2') format('woff2'),
     url('//at.alicdn.com/t/font_1716930_3m30jvz589y.woff') format('woff'),
     <!-- ttf 是 TrueType字体 -->
     url('//at.alicdn.com/t/font_1716930_3m30jvz589y.ttf') format('truetype'),
     url('//at.alicdn.com/t/font_1716930_3m30jvz589y.svg#iconfont') format('svg');
   }
   @font-face {
     font-family: 'iconfont';
     src: url('//at.alicdn.com/t/font_1716930_3m30jvz589y.svg#iconfont') format('svg');
   }
   .iconfont {
     font-family: "iconfont" !important;
     font-size: 16px;
     font-style: normal;
     -webkit-font-smoothing: antialiased;
     -moz-osx-font-smoothing: grayscale;
   }
   .icon-sun:before {
     content: "\e603";
     color: red;
     font-size: 20px;
   }
   ```

5. 使用 SVG 矢量文件
   使用矢量图制作软件，可以直接导出 SVG 格式的矢量图片，这是一种有路径绘制信息的文本描述文件，用这个文件找一个 [image2base64 工具](https://www.sojson.com/image2base64.html)，将文件内容转为 base64 的字符串，然后，就可以在小程序里使用这个 base64 字符串作为图片源。

   ```css
   .svg-icon {
     display: block;
     width: 200px;
     height: 200px;
     background-repeat: no-repeat;
     background: url("data:image/svg+xml;base64,PHN2ZyB0PSIxNTg5MjEzNjE0NDc2IiBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjggMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjEzMDEiIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIj48cGF0aCBkPSJNNTE0LjEzMzMzMyA1MDkuODY2NjY3bS0yNTYgMGEyNTYgMjU2IDAgMSAwIDUxMiAwIDI1NiAyNTYgMCAxIDAtNTEyIDBaIiBmaWxsPSIjZDQyMzdhIiBwLWlkPSIxMzAyIj48L3BhdGg+PHBhdGggZD0iTTUxNC4xMzMzMzMgMTcwLjY2NjY2N2MtMTkuMiAwLTMyLTE0LjkzMzMzMy0zMi0zMlYyOS44NjY2NjdjMC0xNy4wNjY2NjcgMTIuOC0yOS44NjY2NjcgMjkuODY2NjY3LTI5Ljg2NjY2N2gyLjEzMzMzM2MxNy4wNjY2NjcgMCAzMiAxNC45MzMzMzMgMzIgMzJ2MTA4LjhjMCAxNC45MzMzMzMtMTQuOTMzMzMzIDI5Ljg2NjY2Ny0zMiAyOS44NjY2Njd6TTUxNC4xMzMzMzMgMTAyNGMtMTkuMiAwLTMyLTE0LjkzMzMzMy0zMi0zMnYtMTA4LjhjMC0xNy4wNjY2NjcgMTQuOTMzMzMzLTMyIDMyLTMyaDIuMTMzMzM0YzE3LjA2NjY2NyAwIDMyIDE0LjkzMzMzMyAzMiAzMnYxMDguOGMtMi4xMzMzMzMgMTcuMDY2NjY3LTE3LjA2NjY2NyAzMi0zNC4xMzMzMzQgMzJ6TTg1My4zMzMzMzMgNTA5Ljg2NjY2N2MwLTE5LjIgMTQuOTMzMzMzLTMyIDMyLTMyaDEwOC44YzE3LjA2NjY2NyAwIDMyIDE0LjkzMzMzMyAzMiAzMnYyLjEzMzMzM2MwIDE3LjA2NjY2Ny0xNC45MzMzMzMgMzItMzIgMzJoLTEwOC44Yy0xNy4wNjY2NjctMi4xMzMzMzMtMzItMTcuMDY2NjY3LTMyLTM0LjEzMzMzM3pNMCA1MDkuODY2NjY3YzAtMTkuMiAxNC45MzMzMzMtMzIgMzItMzJoMTA4LjhjMTcuMDY2NjY3IDAgMzIgMTQuOTMzMzMzIDMyIDMydjIuMTMzMzMzYzAgMTcuMDY2NjY3LTE0LjkzMzMzMyAzMi0zMiAzMkgzMmMtMTcuMDY2NjY3LTIuMTMzMzMzLTMyLTE3LjA2NjY2Ny0zMi0zNC4xMzMzMzN6TTc0Mi40IDI0Ny40NjY2NjdjLTEyLjgtMTIuOC0xMi44LTMyLTIuMTMzMzMzLTQ0LjhsNzYuOC03Ni44YzEyLjgtMTIuOCAzMi0xMi44IDQ0LjggMFYxMjhjMTIuOCAxMi44IDEyLjggMzIgMCA0NC44bC03Ni44IDc2LjhjLTEwLjY2NjY2NyAxMC42NjY2NjctMzIgMTAuNjY2NjY3LTQyLjY2NjY2Ny0yLjEzMzMzM3pNMTM4LjY2NjY2NyA4NTEuMmMtMTIuOC0xMi44LTEyLjgtMzQuMTMzMzMzLTIuMTMzMzM0LTQ0LjhsNzYuOC03Ni44YzEyLjgtMTIuOCAzMi0xMi44IDQ0LjggMGwyLjEzMzMzNCAyLjEzMzMzM2MxMi44IDEyLjggMTIuOCAzMiAwIDQ0LjhMMTgzLjQ2NjY2NyA4NTMuMzMzMzMzYy0xMi44IDEwLjY2NjY2Ny0zMiAxMC42NjY2NjctNDQuOC0yLjEzMzMzM3pNNzQwLjI2NjY2NyA3MjcuNDY2NjY3YzEyLjgtMTIuOCAzNC4xMzMzMzMtMTIuOCA0NC44LTIuMTMzMzM0bDc2LjggNzYuOGMxMi44IDEyLjggMTIuOCAzMiAwIDQ0LjhsLTIuMTMzMzM0IDIuMTMzMzM0Yy0xMi44IDEyLjgtMzIgMTIuOC00NC44IDBsLTc2LjgtNzYuOGMtMTAuNjY2NjY3LTEyLjgtMTAuNjY2NjY3LTMyIDIuMTMzMzM0LTQ0Ljh6TTEzNi41MzMzMzMgMTIzLjczMzMzM2MxMi44LTEyLjggMzQuMTMzMzMzLTEyLjggNDQuOC0yLjEzMzMzM2w3Ni44IDc2LjhjMTIuOCAxMi44IDEyLjggMzIgMCA0NC44bC0yLjEzMzMzMyAyLjEzMzMzM2MtMTIuOCAxMi44LTMyIDEyLjgtNDQuOCAwTDEzNi41MzMzMzMgMTY4LjUzMzMzM2MtMTAuNjY2NjY3LTEyLjgtMTAuNjY2NjY3LTMyIDAtNDQuOHoiIGZpbGw9IiNGRkM0NDUiIHAtaWQ9IjEzMDMiPjwvcGF0aD48L3N2Zz4=");
   }
   ```

#### 1.1.2 真机上 icon 显示空白问题

在 WXSS 内加载图片及字体文件资源是允许使用外域地址。

- 如果图标是自定义实现的，要检查一下机型及嵌入的字体文件类型，可能是兼容性引起的，在小程序里建议使用 TTF 和 WOFF 格式。
- 如果上面的方法不行，可以考虑 SVG 格式的数据嵌入。

### 1.2 progress

```wxml
<view class="gap">代码示例,单击模拟网络异步</view>
<progress show-info bindtap="onTapProgressBar" stroke-width="2" percent="{{percentValue}}" backgroundColor="#f2f2f2" active-mode="forwards" active bindactiveend="onProgressActiveEnd"/>
```

这里的 activeColor、backgroundColor 要与产品设计保持一致

**问题与思路**:

- 下载文件并显示动态进度条
  启用 active 并将设置 active-mode="forwards" 后，通过文件下载的总大小和已完成大小，实时计算出 percent 数值

- progress 已产生的进度条设置圆角
  可以在本地开发者工具找到 progress 对应的样式名

  ```wxss
  .wx-progress-inner-bar {
    border-radius: 5px;
  }
  ```

- 已经加载完的进度条，点击按钮重新加载

  ```js
  this.setData({ percentValue: 0 });
  // wx.canIUse 判断小程序的API，回调，参数，组件等是否在当前版本可用
  if (wx.canIUse("nextTick")) {
    // 延迟一部分操作到下一个时间片再执行
    wx.nextTick(() => {
      this.setData({ percentValue: 100 });
    });
  } else {
    // 17ms大约是1/60 s，与下一帧刷新有关，类似rAf。
    setTimeout(() => {
      this.setData({ percentValue: 100 });
    }, 17);
  }

  // 每次setData在底层都需要调用 evaluateJavascript 这个底层函数，这个函数用于逻辑层和视图层之间的通讯，执行本来就需要时间
  // 因此直接调用两次 setData ，也可以达到上面的效果
  this.setData({ percentValue: 0 });
  this.setData({ percentValue: 90 });
  ```

## 二. 基础

## 三. 实践
