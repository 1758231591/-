# 应用开发

<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

## 一. Koa

[Koa](https://www.koajs.net/) 是 Node.js 的下一代 Web 框架。所谓的“下一代”是相对于 Express 而言的。Koa 立身于最“潮”的异步流程控制特性，主要用于改进 Node.js 开发中的回调地狱痛点，可以说 Koa 是异步流程控制不断演进的必然产物。

Koa 是由 Express 原班人马打造的，他们的初衷是使 Koa 成为一个更小、更健壮、更富有表现力的 Web“微”框架，进而实现使用 Koa 编写 Web 应用，通过组合各种更高级的异步流程控制中间件，来免除重复烦琐的回调函数嵌套，并极大提升常见错误的处理效率。

Koa 的代码量非常少，是一个极轻量的优雅框架，这使得编写 Web 应用（尤其是开发基于 Koa 的 Web 应用）变得更得心应手。可以把它理解成一个基于 http 模块进行封装的、提供中间件写法的微内核模块。Koa 约定了中间件写法，能够完成 Web 应用里的所有需求。由于 Koa 本身没有内置任何中间件，所以称之为 Web 框架并不完全准确，用 “微” 框架或者 “内核” 模块来描述它更合适。

### 1.1 简介

**应用场景**：

| 场景                 | 描述                                                                                                                                                                                                             | 使用人员         |
| -------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------- |
| 传统 Web 应用开发    | Koa 可以开发带有视图渲染和数据库操作的 Web 应用，主要以网站为主，前后端混在一起，开发简单，是入门和快速开发的利器                                                                                                | 均可             |
| 作为服务器端接口使用 | Koa 可以为 PC 端、移动端、HTML5 端等提供 HTTP API 支持                                                                                                                                                           | 后端开发人员居多 |
| 作为独立的 API 层    | 后端程序可能由多种语言实现，业务划分会导致跨域等各种情况出现，此时可以使用 Koa 作为 API 代理，来请求后端 API，处理后再将结果返回给前端                                                                           | 前端开发人员居多 |
| RPC 服务组装         | 由于历史问题，很多应用采用 RPC 进行服务化，然后组装 RPC 服务将其包装成最终的 HTTP API 提供调用。这是非常好的方式，这种场景是 Koa 非常擅长的。组装 RPC 服务非常简单，不涉及数据库操作，可以按照前端要求的格式处理 | 均可             |
| 静态 API 模拟        | Koa 可以提供静态 API 接口，无须实现具体逻辑，能够加速开发                                                                                                                                                        | 均可             |
| API 网关             | 使用 Node.js 实现 HTTP 代理是非常简单的，使用 Koa 能够更好地请求转发                                                                                                                                             | 均可             |
| 与前端框架集成       | Koa 为 Vue、React 等前端框架的集成提供开发及部署环境的 HTP 服务、静态 API 服务等，结合使用可以实现服务器端渲染或同构开发                                                                                         | 前端开发人员居多 |
| 开发 Web 框架        | Koa 自身没有绑定任何中间件，使用 Koa 时往往要同时使用多个中间件，所以很多框架更愿意将 Koa 作为内核模块，在其之上进行定制开发。                                                                                   | 均可             |

**开发要点**：

Koa 本身比较简单，但要想使用好 Koa，需要掌握以下开发要点：

- Koa 中间件
- ES6 语法
- HTTP 基础
- 异步流程控制
- 数据库操作
- API 接口开发

[示例文件](./examples/hello.mjs)

**优点**：

- 用 async 函数做异步流程控制时，代码更容易理解
- 错误处理干干净净。无论是 async 函数还是 Promise 规范都能非常好地处理异常，另外 Koa 是继承自 Event 的，结合 ctx 里的一些 API 能够更简单地处理错误。
- 具有优雅的回形针中间件机制。通过更少的代码可以完成更多的工作，尤其是能对响应部分进行拦截，这是 Express 等框架无法做到的。
- 性能非常好，比 Express 要好。
- Koa 核心代码量比较少，易于定制，易于在其上开发各种 Web 框架。比如，ThinkJS 和 Egg.js 都是以 Koa v2 作为内核模块开发。
- 社区生态逐渐完善
- 国内外很多公司都已经大量应用 Koa 了，目前 Node.js 的首选 Web 框架是 Koa。
- 拥有 Egg.js（基于 Koa 的成熟的企业级 Web 开发框架），拥有庞大的插件生态。
- 拥有 MidwayJS。它基于 Egg.js 生态，使用 TypeScript 编写，提供 loc 容器，是面向未来的框架。
